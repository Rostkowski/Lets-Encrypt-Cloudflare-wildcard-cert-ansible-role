---
- name: "Install certbot"
  apt:
    name: certbot
    state: latest
    update_cache: yes

- name: "Install jq package"
  apt:
    name: jq
    state: latest
    update_cache: yes

- name: "Create a directory to store shell script to generate certificate"
  ansible.builtin.file:
    path: "/etc/certificate_generation"
    state: "directory"
    mode: "0755"

- name: "Copy certbot dns hook"
  copy:
    src: "{{ certbot_dns_hook_path }}"
    dest: "/etc/certificate_generation/certbot-dns-hook.sh"
    mode: "u=rwx,g=r,o=r"

- name: "Generate certificate"
  vars:
    prefix_www: "www."
    list_of_present_root_domains: '{{ hosted_domains | selectattr("state", "equalto", "present") | map(attribute="domain") | list }}'
    list_of_present_root_domains_with_www: '{{ [prefix_www] | product(hosted_domains) | map("join") | list }}'
    complete_list_of_domains: '{{ list_of_present_root_domains + list_of_present_root_domains_with_www }}'
  shell: 'certbot certonly \
    --manual \
    --cert-name {{ cert_name }} \
    --preferred-challenges=dns \
    --email={{ domain_admin_email }} \
    --agree-tos \
    --domains {{ complete_list_of_domains|join(",") }} \
    --non-interactive \
    --manual-auth-hook="/etc/certificate_generation/certbot-dns-hook.sh create_record {{ api_key }}" \
    --manual-cleanup-hook="/etc/certificate_generation/certbot-dns-hook.sh remove_record {{ api_key }}"' 
